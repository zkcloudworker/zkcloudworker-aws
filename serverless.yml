org: dfstio
app: zkcloudworker
service: zkcloudworker

plugins:
  - serverless-plugin-typescript
  - serverless-prune-plugin
  - "@digitalmaas/serverless-plugin-lambda-dead-letter"
  - serverless-iam-roles-per-function

provider:
  name: aws
  versionFunctions: false
  runtime: nodejs20.x
  region: eu-west-1
  logRetentionInDays: 30
  #architecture: arm64 #o1js is not compatible yet - https://github.com/o1-labs/o1js/issues/1525
  environment:
    TASKS_TABLE: ${file(./env.json):TASKS_TABLE, env:TASKS_TABLE}
    DEPLOYERS_TABLE: ${file(./env.json):DEPLOYERS_TABLE, env:DEPLOYERS_TABLE}
    FILES_TABLE: ${file(./env.json):FILES_TABLE, env:FILES_TABLE}
    TRANSACTIONS_TABLE: ${file(./env.json):TRANSACTIONS_TABLE, env:TRANSACTIONS_TABLE}
    KV_TABLE: ${file(./env.json):KV_TABLE, env:KV_TABLE}
    JOBS_TABLE: ${file(./env.json):JOBS_TABLE, env:JOBS_TABLE}
    JOB_EVENTS_TABLE: ${file(./env.json):JOB_EVENTS_TABLE, env:JOB_EVENTS_TABLE}
    STEPS_TABLE: ${file(./env.json):STEPS_TABLE, env:STEPS_TABLE}
    PROOFS_TABLE: ${file(./env.json):PROOFS_TABLE, env:PROOFS_TABLE}
    WORKERS_TABLE: ${file(./env.json):WORKERS_TABLE, env:WORKERS_TABLE}
    BALANCE_TABLE: ${file(./env.json):BALANCE_TABLE, env:BALANCE_TABLE}
    RATE_LIMIT_TABLE: ${file(./env.json):RATE_LIMIT_TABLE, env:RATE_LIMIT_TABLE}
    BUCKET: ${file(./env.json):BUCKET_NAME, env:BUCKET_NAME}
    COREPACK_HOME: ${file(./env.json):COREPACK_HOME, env:COREPACK_HOME}
    HOME: ${file(./env.json):HOME, env:HOME}
    VERIFICATION_BUCKET: ${file(./env.json):VERIFICATION_BUCKET_NAME, env:VERIFICATION_BUCKET_NAME}
    AWS_KMS_ENCRYPTION_KEY_ID: ${file(./env.json):AWS_KMS_ENCRYPTION_KEY_ID, env:AWS_KMS_ENCRYPTION_KEY_ID}
    JWT_PRIVATEKEY: ${file(./env.json):JWT_PRIVATEKEY, env:JWT_PRIVATEKEY}
    JWT_ACCESS_KEY: ${file(./env.json):JWT_ACCESS_KEY, env:JWT_ACCESS_KEY}
    ZKCLOUDWORKER_AUTH: ${file(./env.json):ZKCLOUDWORKER_AUTH, env:ZKCLOUDWORKER_AUTH}
    PINATA_JWT: ${file(./env.json):PINATA_JWT, env:PINATA_JWT}
    ALGOLIA_KEY: ${file(./env.json):ALGOLIA_KEY, env:ALGOLIA_KEY}
    ALGOLIA_PROJECT: ${file(./env.json):ALGOLIA_PROJECT, env:ALGOLIA_PROJECT}
    BLOCKBERRY_API_KEY: ${file(./env.json):BLOCKBERRY_API_KEY, env:BLOCKBERRY_API_KEY}
    ZKCW_WALLET_ADDRESS: ${file(./env.json):ZKCW_WALLET_ADDRESS, env:ZKCW_WALLET_ADDRESS}
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "ses:*"
        - lambda:InvokeFunction
        - lambda:UpdateFunctionConfiguration
      Resource:
        - "*"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TASKS_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.FILES_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOBS_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOB_EVENTS_TABLE}"

    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRANSACTIONS_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.KV_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.STEPS_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.PROOFS_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.WORKERS_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.BALANCE_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DEPLOYERS_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:DescribeTimeToLive
        - dynamodb:UpdateTimeToLive
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.RATE_LIMIT_TABLE}"
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:PutObjectAcl
        - s3:GetObject
        - s3:GetObjectAcl
        - s3:HeadObject
        - s3:ListBucket
        - s3:DeleteObject
      Resource: "arn:aws:s3:::${self:provider.environment.BUCKET}/*"
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:PutObjectAcl
        - s3:GetObject
        - s3:GetObjectAcl
        - s3:HeadObject
        - s3:ListBucket
        - s3:DeleteObject
      Resource: "arn:aws:s3:::${self:provider.environment.VERIFICATION_BUCKET}/*"
    - Effect: Allow
      Action:
        - ec2:DescribeNetworkInterfaces
        - ec2:CreateNetworkInterface
        - ec2:DeleteNetworkInterface
        - ec2:AssignPrivateIpAddresses
        - ec2:UnassignPrivateIpAddresses
      Resource: "*"
    - Effect: Allow
      Action:
        - elasticfilesystem:ClientMount
        - elasticfilesystem:ClientRootAccess
        - elasticfilesystem:ClientWrite
        - elasticfilesystem:DescribeMountTargets
      Resource: "*"
    - Effect: Allow
      Action:
        - kms:Encrypt
        - kms:Decrypt
        - kms:Encrypt*
        - kms:Decrypt*
      Resource: "*"
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
        - sqs:DeleteMessage
        - sqs:GetQueueAttributes
      Resource: "*"
    - Effect: Allow
      Action:
        - logs:GetLogEvents
      Resource: "*"
    - Effect: Allow
      Action:
        - lightsail:GetInstanceState
        - lightsail:RebootInstance
        - lightsail:GetInstanceMetricData
      Resource: "*"

functions:
  zkcloudworker-devnet:
    handler: zkcloudworker.api
    timeout: 30
    memorySize: 1024
    reservedConcurrency: 20 # optional, reserved concurrency limit for this function. By default, AWS uses account concurrency limit
    deadLetter:
      sqs:
        queueName: zkcloudworker-devnet-dl-queue
    events:
      - http:
          path: devnet
          method: post
          cors: true
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  zkcloudworker-mainnet:
    handler: zkcloudworker.api
    timeout: 30
    memorySize: 1024
    reservedConcurrency: 20 # optional, reserved concurrency limit for this function. By default, AWS uses account concurrency limit
    deadLetter:
      sqs:
        queueName: zkcloudworker-mainnet-dl-queue
    events:
      - http:
          path: mainnet
          method: post
          cors: true
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  zkcloudworker-zeko:
    handler: zkcloudworker.api
    timeout: 30
    memorySize: 1024
    reservedConcurrency: 20 # optional, reserved concurrency limit for this function. By default, AWS uses account concurrency limit
    deadLetter:
      sqs:
        queueName: zkcloudworker-zeko-dl-queue
    events:
      - http:
          path: zeko
          method: post
          cors: true
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  worker-devnet:
    handler: zkcloudworker.worker
    timeout: 900
    memorySize: 10240
    reservedConcurrency: 20
    environment:
      JWT_PRIVATEKEY: ""
      JWT_ACCESS_KEY: ""
      ZKCLOUDWORKER_AUTH: ""
      PINATA_JWT: ""
      BLOCKBERRY_API_KEY: ""
      ZKCW_WALLET_ADDRESS: ""
    iamRoleStatementsName: worker-devnet-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:DescribeTimeToLive
          - dynamodb:UpdateTimeToLive
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.RATE_LIMIT_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TASKS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.FILES_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOBS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOB_EVENTS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:Query
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRANSACTIONS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.KV_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.STEPS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.PROOFS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.WORKERS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.BALANCE_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DEPLOYERS_TABLE}"
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
          - s3:HeadObject
          - s3:DeleteObject
          - s3:PutObjectAcl
        Resource: "arn:aws:s3:::${self:provider.environment.BUCKET}/*"
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource: "arn:aws:s3:::${self:provider.environment.VERIFICATION_BUCKET}/*"
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:Encrypt*
          - kms:Decrypt*
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: "*"
      - Effect: Allow
        Action:
          - logs:GetLogEvents
        Resource: "*"
      - Effect: "Allow"
        Action:
          - "ses:*"
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-charge
      - Effect: "Allow"
        Action:
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-sequencer
      - Effect: "Allow"
        Action:
          - lambda:InvokeFunction
        Resource: arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-nats
      - Effect: "Allow"
        Action:
          - lambda:UpdateFunctionConfiguration
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-worker-devnet
    deadLetter:
      sqs:
        queueName: worker-devnet-dl-queue
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  worker-mainnet:
    handler: zkcloudworker.worker
    timeout: 900
    memorySize: 10240
    reservedConcurrency: 20
    environment:
      JWT_PRIVATEKEY: ""
      JWT_ACCESS_KEY: ""
      ZKCLOUDWORKER_AUTH: ""
      PINATA_JWT: ""
      BLOCKBERRY_API_KEY: ""
      ZKCW_WALLET_ADDRESS: ""
    iamRoleStatementsName: worker-mainnet-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:DescribeTimeToLive
          - dynamodb:UpdateTimeToLive
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.RATE_LIMIT_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TASKS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.FILES_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOBS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOB_EVENTS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:Query
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRANSACTIONS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.KV_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.STEPS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.PROOFS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.WORKERS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.BALANCE_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DEPLOYERS_TABLE}"
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
          - s3:HeadObject
          - s3:DeleteObject
          - s3:PutObjectAcl
        Resource: "arn:aws:s3:::${self:provider.environment.BUCKET}/*"
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource: "arn:aws:s3:::${self:provider.environment.VERIFICATION_BUCKET}/*"
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:Encrypt*
          - kms:Decrypt*
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: "*"
      - Effect: Allow
        Action:
          - logs:GetLogEvents
        Resource: "*"
      - Effect: "Allow"
        Action:
          - "ses:*"
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-charge
      - Effect: "Allow"
        Action:
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-sequencer
      - Effect: "Allow"
        Action:
          - lambda:InvokeFunction
        Resource: arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-nats
      - Effect: "Allow"
        Action:
          - lambda:UpdateFunctionConfiguration
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-worker-mainnet
    deadLetter:
      sqs:
        queueName: worker-mainnet-dl-queue
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  worker-zeko:
    handler: zkcloudworker.worker
    timeout: 900
    memorySize: 10240
    reservedConcurrency: 20
    environment:
      JWT_PRIVATEKEY: ""
      JWT_ACCESS_KEY: ""
      ZKCLOUDWORKER_AUTH: ""
      PINATA_JWT: ""
      BLOCKBERRY_API_KEY: ""
      ZKCW_WALLET_ADDRESS: ""
    iamRoleStatementsName: worker-zeko-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:DescribeTimeToLive
          - dynamodb:UpdateTimeToLive
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.RATE_LIMIT_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TASKS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.FILES_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOBS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOB_EVENTS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:Query
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRANSACTIONS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.KV_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.STEPS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.PROOFS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.WORKERS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.BALANCE_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DEPLOYERS_TABLE}"
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
          - s3:HeadObject
          - s3:DeleteObject
          - s3:PutObjectAcl
        Resource: "arn:aws:s3:::${self:provider.environment.BUCKET}/*"
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource: "arn:aws:s3:::${self:provider.environment.VERIFICATION_BUCKET}/*"
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:Encrypt*
          - kms:Decrypt*
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: "*"
      - Effect: Allow
        Action:
          - logs:GetLogEvents
        Resource: "*"
      - Effect: "Allow"
        Action:
          - "ses:*"
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-charge
      - Effect: "Allow"
        Action:
          - lambda:InvokeFunction
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-sequencer
      - Effect: "Allow"
        Action:
          - lambda:InvokeFunction
        Resource: arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-nats
      - Effect: "Allow"
        Action:
          - lambda:UpdateFunctionConfiguration
        Resource:
          - arn:aws:lambda:eu-west-1:058264205854:function:zkcloudworker-dev-worker-zeko
      - Effect: Allow
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:Encrypt*
          - kms:Decrypt*
        Resource: "*"

    deadLetter:
      sqs:
        queueName: worker-zeko-dl-queue
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  test:
    handler: test.cloud
    timeout: 900
    memorySize: 10240
    reservedConcurrency: 2
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  mocked-sequencer:
    handler: mocked.sequencer
    timeout: 30
    memorySize: 192
    reservedConcurrency: 30
    deadLetter:
      sqs:
        queueName: mocked-sequencer-dl-queue
  tasks:
    handler: tasks.check
    timeout: 300
    memorySize: 256
    reservedConcurrency: 20
    events:
      - schedule:
          rate: rate(5 minutes)
          enabled: true
          name: ts
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  charge:
    handler: charge.run
    timeout: 30
    memorySize: 384
    reservedConcurrency: 20
  nats:
    handler: nats.publish
    timeout: 60
    memorySize: 384
  sequencer:
    handler: sequencer.run
    timeout: 900
    memorySize: 384
    reservedConcurrency: 20
    deadLetter:
      sqs:
        queueName: sequencer-dl-queue
  step-devnet:
    handler: step.run
    timeout: 300
    memorySize: 10240
    reservedConcurrency: 64
    environment:
      JWT_PRIVATEKEY: ""
      JWT_ACCESS_KEY: ""
      ZKCLOUDWORKER_AUTH: ""
      PINATA_JWT: ""
      BLOCKBERRY_API_KEY: ""
      ZKCW_WALLET_ADDRESS: ""
    iamRoleStatementsName: step-devnet-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOBS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOB_EVENTS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.KV_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.STEPS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.PROOFS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.WORKERS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.BALANCE_TABLE}"
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
          - s3:HeadObject
          - s3:DeleteObject
        Resource: "arn:aws:s3:::${self:provider.environment.BUCKET}/*"
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:Encrypt*
          - kms:Decrypt*
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: "*"
      - Effect: Allow
        Action:
          - logs:GetLogEvents
        Resource: "*"
    deadLetter:
      sqs:
        queueName: step-devnet-dl-queue
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  step-mainnet:
    handler: step.run
    timeout: 300
    memorySize: 10240
    reservedConcurrency: 64
    environment:
      JWT_PRIVATEKEY: ""
      JWT_ACCESS_KEY: ""
      ZKCLOUDWORKER_AUTH: ""
      PINATA_JWT: ""
      BLOCKBERRY_API_KEY: ""
      ZKCW_WALLET_ADDRESS: ""
    iamRoleStatementsName: step-mainnet-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOBS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOB_EVENTS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.KV_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.STEPS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.PROOFS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.WORKERS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.BALANCE_TABLE}"
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
          - s3:HeadObject
          - s3:DeleteObject
        Resource: "arn:aws:s3:::${self:provider.environment.BUCKET}/*"
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:Encrypt*
          - kms:Decrypt*
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: "*"
      - Effect: Allow
        Action:
          - logs:GetLogEvents
        Resource: "*"
    deadLetter:
      sqs:
        queueName: step-mainnet-dl-queue
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699
  step-zeko:
    handler: step.run
    timeout: 300
    memorySize: 10240
    reservedConcurrency: 64
    environment:
      JWT_PRIVATEKEY: ""
      JWT_ACCESS_KEY: ""
      ZKCLOUDWORKER_AUTH: ""
      PINATA_JWT: ""
      BLOCKBERRY_API_KEY: ""
      ZKCW_WALLET_ADDRESS: ""
    iamRoleStatementsName: step-zeko-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOBS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.JOB_EVENTS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.KV_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.STEPS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.PROOFS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.WORKERS_TABLE}"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.BALANCE_TABLE}"
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:GetObject
          - s3:HeadObject
          - s3:DeleteObject
        Resource: "arn:aws:s3:::${self:provider.environment.BUCKET}/*"
      - Effect: Allow
        Action:
          - elasticfilesystem:ClientMount
          - elasticfilesystem:ClientWrite
        Resource: "*"
      - Effect: Allow
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:Encrypt*
          - kms:Decrypt*
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: "*"
      - Effect: Allow
        Action:
          - logs:GetLogEvents
        Resource: "*"
    fileSystemConfig:
      localMountPath: /mnt/efs
      arn: arn:aws:elasticfilesystem:eu-west-1:058264205854:access-point/fsap-04fa7f21664729898
    vpc:
      securityGroupIds:
        - sg-07cdd56c86fb70d88
      subnetIds:
        - subnet-0c3cc81920de4c4c3
        - subnet-08f6fb90590c47699

resources:
  Resources:
    Bucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.BUCKET}
        AccessControl: Private
    TasksDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: taskId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
          - AttributeName: taskId
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.TASKS_TABLE}
    BalanceDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.BALANCE_TABLE}
    FilesDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: filename
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
          - AttributeName: filename
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.FILES_TABLE}
    TransactionsDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: repoId
            AttributeType: S
          - AttributeName: txId
            AttributeType: S
        KeySchema:
          - AttributeName: repoId
            KeyType: HASH
          - AttributeName: txId
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.TRANSACTIONS_TABLE}
    KeyValueDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: repoId
            AttributeType: S
          - AttributeName: keyId
            AttributeType: S
        KeySchema:
          - AttributeName: repoId
            KeyType: HASH
          - AttributeName: keyId
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.KV_TABLE}
    JobsDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: jobId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
          - AttributeName: jobId
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.JOBS_TABLE}
    JobEventsDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: jobId
            AttributeType: S
          - AttributeName: eventTime
            AttributeType: N
        KeySchema:
          - AttributeName: jobId
            KeyType: HASH
          - AttributeName: eventTime
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.JOB_EVENTS_TABLE}
    StepsDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: jobId
            AttributeType: S
          - AttributeName: stepId
            AttributeType: S
        KeySchema:
          - AttributeName: jobId
            KeyType: HASH
          - AttributeName: stepId
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.STEPS_TABLE}
    ProofsDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: jobId
            AttributeType: S
          - AttributeName: stepId
            AttributeType: S
        KeySchema:
          - AttributeName: jobId
            KeyType: HASH
          - AttributeName: stepId
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.PROOFS_TABLE}
    WorkersDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: developer
            AttributeType: S
          - AttributeName: repo
            AttributeType: S
        KeySchema:
          - AttributeName: developer
            KeyType: HASH
          - AttributeName: repo
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.WORKERS_TABLE}
    DeployersDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: publicKey
            AttributeType: S
          - AttributeName: chain
            AttributeType: S
        KeySchema:
          - AttributeName: publicKey
            KeyType: HASH
          - AttributeName: chain
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.DEPLOYERS_TABLE}
    RateLimitDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          - AttributeName: key
            AttributeType: S
        KeySchema:
          - AttributeName: key
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:provider.environment.RATE_LIMIT_TABLE}

package:
  excludeDevDependencies: true
  exclude:
    - test/**
    - jest.config.js
    - tsconfig.json
    - tslint.json
    - env*.json
    - .travis.yml
    - .prettierrc
    - node_modules/aws-sdk/**

custom:
  s3Bucket: formbucket-${self:provider.environment.BUCKET}
